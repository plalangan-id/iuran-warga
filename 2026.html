<script>
    // URL CSV Anda
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSqOacaVgTEVIQdIOgsacKIqQtqfTqUH5F_UMoI5R6ci5fxg2Px6BHrdlfntfdR7Md7T3TshmUHtG7V/pub?gid=0&single=true&output=csv';

    function cekModeTersimpan() {
        const statusMode = localStorage.getItem('darkMode');
        if (statusMode === 'aktif') {
            document.body.classList.add('dark-mode');
            if(document.getElementById('txtM')) document.getElementById('txtM').innerText = "‚òÄÔ∏è Mode Terang";
        }
    }

    function gantiMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDark ? 'aktif' : 'nonaktif');
        if(document.getElementById('txtM')) document.getElementById('txtM').innerText = isDark ? "‚òÄÔ∏è Mode Terang" : "üåô Mode Gelap";
    }

    function parseCSV(text) {
        if(!text) return [];
        const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
        return text.split(/\r?\n/).map(line => line.split(regex).map(cell => cell.replace(/^"|"$/g, '').trim()));
    }

    async function init() {
        cekModeTersimpan();
        try {
            const resp = await fetch(csvUrl + '&v=' + new Date().getTime());
            const rawData = await resp.text();
            window.db = parseCSV(rawData);

            if (!window.db || window.db.length < 2) return;

            // 1. PENGUMUMAN (Kolom E / Indeks 4)
            const pengumuman = window.db[1][4];
            if (pengumuman && pengumuman.trim() !== "") {
                document.getElementById('pBox').style.display = 'block';
                document.getElementById('pIsi').innerText = pengumuman;
            }

            // 2. SALDO AWAL (Kolom H / Indeks 7)
            let saldoAwal = 0;
            if (window.db[1] && window.db[1][7]) {
                saldoAwal = parseInt(window.db[1][7].replace(/[^0-9]/g, '')) || 0;
            }

            let iuranBaru = 0;
            let rekapBulanan = {};

            // Loop Data (Mulai Baris 2)
            for(let i=1; i < window.db.length; i++) {
                let baris = window.db[i];
                if(!baris) continue;

                // Hitung Iuran Masuk (Kolom D / Indeks 3)
                if(baris[3] && baris[3] !== "") {
                    let nom = parseInt(baris[3].replace(/[^0-9]/g, '')) || 0;
                    let bln = baris[2]; // Kolom C (Bulan)
                    
                    iuranBaru += nom;
                    if (bln) {
                        rekapBulanan[bln] = (rekapBulanan[bln] || 0) + nom;
                    }
                }
            }

            // Tampilkan Tabel Rekap
            let rekapHTML = "";
            const urutanBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            urutanBulan.forEach(b => {
                if (rekapBulanan[b]) {
                    rekapHTML += `<tr><td>${b}</td><td>Rp ${rekapBulanan[b].toLocaleString('id-ID')}</td></tr>`;
                }
            });
            document.getElementById('listRekapBulan').innerHTML = rekapHTML || "<tr><td colspan='2'>Belum ada data iuran</td></tr>";

            // 3. HITUNG PENGELUARAN (Kolom G / Indeks 6)
            let totalKotor = saldoAwal + iuranBaru;
            document.getElementById('totalKas').innerText = "Rp " + totalKotor.toLocaleString('id-ID');

            let rincianHTML = "";
            let totalKeluar = 0;

            if (saldoAwal > 0) {
                rincianHTML += `‚Ä¢ Saldo Bulan Lalu: <span style="color:var(--primary)">Rp ${saldoAwal.toLocaleString('id-ID')}</span><br>`;
            }

            for (let i = 1; i < window.db.length; i++) {
                let baris = window.db[i];
                let teksKeluar = baris[5]; // Kolom F (Keterangan)
                let angkaKeluar = baris[6]; // Kolom G (Nominal Keluar)
                
                if (teksKeluar && teksKeluar.trim() !== "" && angkaKeluar) {
                    let nomKeluar = parseInt(angkaKeluar.replace(/[^0-9]/g, '')) || 0;
                    totalKeluar += nomKeluar;
                    rincianHTML += `‚Ä¢ ${teksKeluar} (<span style="color:var(--danger)">-Rp ${nomKeluar.toLocaleString('id-ID')}</span>)<br>`;
                }
            }

            document.getElementById('listKeluar').innerHTML = rincianHTML || "Belum ada catatan keuangan.";
            document.getElementById('sisaKas').innerText = "Rp " + (totalKotor - totalKeluar).toLocaleString('id-ID');

        } catch (err) { 
            console.error("Error Detail:", err);
            alert("Terjadi kesalahan pembacaan data. Pastikan Google Sheets sudah di-Publish ke Web sebagai CSV.");
        }
    }

    function cariData() {
        const query = document.getElementById('inNama').value.toLowerCase().trim();
        const grid = document.getElementById('gridBulan');
        const head = document.getElementById('resHead');
        
        if (query.length < 3) { 
            grid.innerHTML = ""; 
            head.style.display = "none"; 
            return; 
        }
        
        let matches = [];
        let displayNama = "";
        
        window.db.forEach((row, idx) => {
            if (idx === 0 || !row[1]) return;
            // Cari di Kolom B (Nama)
            if (row[1].toLowerCase().includes(query)) {
                matches.push({ bulan: row[2], tanggal: row[0] });
                displayNama = row[1].toUpperCase(); 
            }
        });

        if (matches.length > 0) {
            head.style.display = "block";
            document.getElementById('resNama').innerText = displayNama;
            
            const bulanArr = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agt", "Sep", "Okt", "Nov", "Des"];
            const bulanFull = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            grid.innerHTML = "";
            bulanFull.forEach((blnFull, index) => {
                const bayar = matches.find(m => m.bulan && m.bulan.toLowerCase() === blnFull.toLowerCase());
                const div = document.createElement('div');
                div.className = `card ${bayar ? 'lunas' : 'belum'}`;
                div.innerHTML = `
                    <div style="font-size:10px; font-weight:bold">${bulanArr[index]}</div>
                    <div style="font-size:18px; margin:3px 0">${bayar ? '‚úÖ' : '‚ùå'}</div>
                    <div style="font-size:8px; font-weight:bold">${bayar ? 'LUNAS' : 'BELUM'}</div>
                    ${bayar ? `<span class="tgl">${bayar.tanggal}</span>` : ''}
                `;
                grid.appendChild(div);
            });
        } else {
            grid.innerHTML = "<p style='grid-column: span 4; text-align: center; color: var(--danger); font-size:12px;'>Nama tidak ditemukan</p>";
            head.style.display = "none";
        }
    }
    
    // Jalankan aplikasi
    window.onload = init;
</script>
