<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSqOacaVgTEVIQdIOgsacKIqQtqfTqUH5F_UMoI5R6ci5fxg2Px6BHrdlfntfdR7Md7T3TshmUHtG7V/pub?gid=0&single=true&output=csv';

    async function init() {
        try {
            const response = await fetch(csvUrl + '&nocache=' + new Date().getTime());
            const data = await response.text();
            
            // Parsing baris dan buang baris yang benar-benar kosong
            const allRows = data.split(/\r?\n/).map(row => {
                return row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.replace(/^"|"$/g, '').trim());
            });
            
            // Simpan ke window.db hanya baris yang punya data
            window.db = allRows.filter(r => r.join('').length > 0);

            if (window.db.length < 2) return;

            // 1. Ambil Pengumuman (Kolom E / Indeks 4) dari baris manapun yang ada isinya
            const barisInfo = window.db.find(r => r[4] && r[4] !== "");
            if (barisInfo) {
                document.getElementById('pBox').style.display = 'block';
                document.getElementById('pIsi').innerText = barisInfo[4];
            }

            // 2. Ambil Saldo Awal (Kolom H / Indeks 7)
            const barisSaldo = window.db.find(r => r[7] && r[7] !== "");
            let saldoLalu = barisSaldo ? parseInt(barisSaldo[7].replace(/[^0-9]/g, '')) || 0 : 0;

            let totalIuran = 0;
            let totalKeluar = 0;
            let rekapBulan = {};
            let htmlKeluar = "";

            for(let i=1; i < window.db.length; i++) {
                let r = window.db[i];

                // Hitung Iuran (Cek Kolom B Nama & Kolom D Nominal)
                if(r[1] && r[3]) {
                    let nominal = parseInt(r[3].replace(/[^0-9]/g, '')) || 0;
                    totalIuran += nominal;
                    if(r[2]) rekapBulan[r[2]] = (rekapBulan[r[2]] || 0) + nominal;
                }

                // Hitung Pengeluaran (Kolom F & G)
                if(r[5] && r[6]) {
                    let nominalKeluar = parseInt(r[6].replace(/[^0-9]/g, '')) || 0;
                    totalKeluar += nominalKeluar;
                    htmlKeluar += `‚Ä¢ ${r[5]} (<span style="color:var(--danger)">-Rp ${nominalKeluar.toLocaleString('id-ID')}</span>)<br>`;
                }
            }

            // Tampilkan ke layar
            document.getElementById('totalKas').innerText = "Rp " + (saldoLalu + totalIuran).toLocaleString('id-ID');
            document.getElementById('sisaKas').innerText = "Rp " + (saldoLalu + totalIuran - totalKeluar).toLocaleString('id-ID');
            document.getElementById('listKeluar').innerHTML = htmlKeluar || "Tidak ada catatan pengeluaran.";

            let htmlRekap = "";
            const bulanFull = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
            bulanFull.forEach(b => {
                if(rekapBulan[b]) {
                    htmlRekap += `<tr><td>${b}</td><td style="text-align:right; font-weight:bold; color:var(--primary)">Rp ${rekapBulan[b].toLocaleString('id-ID')}</td></tr>`;
                }
            });
            document.getElementById('listRekapBulan').innerHTML = htmlRekap || "<tr><td>Belum ada data iuran.</td></tr>";

        } catch (error) {
            console.error("Gagal Memuat:", error);
        }
    }

    function cariData() {
        let keyword = document.getElementById('inNama').value.toLowerCase().trim();
        let grid = document.getElementById('gridBulan');
        let resHead = document.getElementById('resHead');

        if(keyword.length < 3) { grid.innerHTML = ""; resHead.style.display = "none"; return; }

        // Filter hanya baris yang ada namanya (Kolom B)
        let matches = window.db.filter(row => row[1] && row[1].toLowerCase().includes(keyword));

        if(matches.length > 0) {
            resHead.style.display = "block";
            document.getElementById('resNama').innerText = matches[0][1].toUpperCase();
            grid.innerHTML = "";
            
            const bulanFull = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
            const bulanSingkat = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agt","Sep","Okt","Nov","Des"];

            bulanFull.forEach((b, idx) => {
                let dataBayar = matches.find(m => m[2] === b);
                let box = document.createElement('div');
                box.className = `card ${dataBayar ? 'lunas' : 'belum'}`;
                box.innerHTML = `<small>${bulanSingkat[idx]}</small><br>${dataBayar ? '‚úÖ' : '‚ùå'}<br><small>${dataBayar ? 'LUNAS' : 'BELUM'}</small>`;
                grid.appendChild(box);
            });
        } else {
            grid.innerHTML = "<p style='grid-column: span 4; text-align: center; font-size: 12px; color: var(--danger);'>Nama tidak ditemukan</p>";
        }
    }

    function gantiMode() {
        document.body.classList.toggle('dark-mode');
        document.getElementById('txtM').innerText = document.body.classList.contains('dark-mode') ? "‚òÄÔ∏è Mode Terang" : "üåô Mode Gelap";
    }

    window.onload = init;
</script>
